#!/bin/bash
# –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã –∏ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ Pantum P2200 –¥–ª—è Ubuntu Server
# –í–ê–ñ–ù–û: –∑–∞–ø—É—Å–∫–∞—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: sudo bash full_fix_script.sh

set -e  # –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
exec > >(tee /var/log/full_fix_script.log) 2>&1  # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å—å –≤—ã–≤–æ–¥ –≤ –ª–æ–≥

echo "======================================================"
echo "  –ù–ê–ß–ê–õ–û –ü–û–õ–ù–û–ô –ù–ê–°–¢–†–û–ô–ö–ò –°–ò–°–¢–ï–ú–´ –ò –ü–†–ò–ù–¢–ï–†–ê"
echo "======================================================"
echo "–õ–æ–≥ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ /var/log/full_fix_script.log"
echo ""

# --- –†–ê–ó–î–ï–õ 1: –ü–û–î–ì–û–¢–û–í–ö–ê –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ---
echo "[1/7] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –≤–∞–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
BACKUP_DIR="/root/backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

cp -r /etc/cups $BACKUP_DIR/ 2>/dev/null || true
cp /etc/apt/sources.list $BACKUP_DIR/ 2>/dev/null || true
echo "  ‚úÖ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ $BACKUP_DIR"

# --- –†–ê–ó–î–ï–õ 2: –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ò –Ø–î–†–ê ---
echo "[2/7] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º—ã..."

apt update
apt upgrade -y

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã (–≤–∞–∂–Ω–æ –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –¥—Ä–∞–π–≤–µ—Ä–æ–≤)[citation:1]
apt install -y linux-generic-hwe-$(lsb_release -sr)
echo "  ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏ —è–¥—Ä–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# --- –†–ê–ó–î–ï–õ 3: –†–ê–ë–û–¢–ê –° –î–†–ê–ô–í–ï–†–ê–ú–ò –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø ---
echo "[3/7] –ü–æ–∏—Å–∫ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –¥–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è..."

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏[citation:9]
apt install -y ubuntu-drivers-common

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –¥—Ä–∞–π–≤–µ—Ä–æ–≤
ubuntu-drivers autoinstall
echo "  ‚úÖ –†–∞–±–æ—Ç–∞ —Å –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# --- –†–ê–ó–î–ï–õ 4: –ü–û–õ–ù–ê–Ø –ü–ï–†–ï–£–°–¢–ê–ù–û–í–ö–ê –ò –ù–ê–°–¢–†–û–ô–ö–ê CUPS ---
echo "[4/7] –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CUPS..."

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ CUPS[citation:8]
systemctl stop cups 2>/dev/null || true
apt purge -y cups* cups-filters*
apt autoremove -y

# –ß–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ CUPS –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤[citation:8]
apt install -y cups cups-client cups-filters cups-ipp-utils
apt install -y printer-driver-cups-pdf ghostscript

# –í–∫–ª—é—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É[citation:8]
cupsctl --remote-any --remote-admin
systemctl restart cups
systemctl enable cups

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É lpadmin
usermod -aG lpadmin $SUDO_USER
echo "  ‚úÖ CUPS –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# --- –†–ê–ó–î–ï–õ 5: –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–í–ï–°–¢–ù–´–• –û–®–ò–ë–û–ö –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ---
echo "[5/7] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ cupsd.conf[citation:10]
if grep -q "JobPrivateAccess" /etc/cups/cupsd.conf && ! grep -q "<Policy" /etc/cups/cupsd.conf; then
    echo "  ‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ cupsd.conf, –∏—Å–ø—Ä–∞–≤–ª—è—é..."
    sed -i '/JobPrivateAccess/d' /etc/cups/cupsd.conf
    systemctl restart cups
fi

# --- –†–ê–ó–î–ï–õ 6: –î–û–ë–ê–í–õ–ï–ù–ò–ï –ò –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò–ù–¢–ï–†–ê PANTUM P2200 ---
echo "[6/7] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ Pantum P2200..."

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏–Ω—Ç–µ—Ä–∞
lpadmin -x Pantum_P2200_series 2>/dev/null || true
lpadmin -x Pantum_PZ200_series 2>/dev/null || true

# –ü–æ–∏—Å–∫ USB-–ø–æ—Ä—Ç–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
PRINTER_URI=$(lpinfo -v | grep -i "pantum\|usb" | head -1)
if [ -z "$PRINTER_URI" ]; then
    echo "  ‚ö†Ô∏è  –ü—Ä–∏–Ω—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ USB-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ."
    echo "  üí° –í—Å—Ç–∞–≤—å—Ç–µ USB-–∫–∞–±–µ–ª—å –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏..."
    read
    PRINTER_URI=$(lpinfo -v | grep -i "pantum\|usb" | head -1)
fi

if [ ! -z "$PRINTER_URI" ]; then
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ç–µ—Ä–∞[citation:8]
    lpadmin -p Pantum_P2200_series \
        -E \
        -v "$PRINTER_URI" \
        -m "drv:///sample.drv/generic.ppd" \
        -o printer-is-shared=false \
        -o PageSize=A4
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    lpadmin -d Pantum_P2200_series
    cupsenable Pantum_P2200_series
    cupsaccept Pantum_P2200_series
    echo "  ‚úÖ –ü—Ä–∏–Ω—Ç–µ—Ä Pantum_P2200_series –¥–æ–±–∞–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
else
    echo "  ‚ùå –ü—Ä–∏–Ω—Ç–µ—Ä –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∞—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞..."
fi

# --- –†–ê–ó–î–ï–õ 7: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò –û–¢–ß–ï–¢ ---
echo "[7/7] –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞..."

echo ""
echo "======================================================"
echo "               –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ò–ò"
echo "======================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è CUPS
echo "1. –°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±—ã CUPS:"
systemctl status cups --no-pager | head -5

echo ""
echo "2. –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤:"
lpstat -p 2>/dev/null || echo "  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤"

echo ""
echo "3. –ü—Ä–∏–Ω—Ç–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:"
lpstat -d 2>/dev/null || echo "  –ü—Ä–∏–Ω—Ç–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –∑–∞–¥–∞–Ω"

echo ""
echo "4. –û—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏:"
lpstat -o 2>/dev/null || echo "  –û—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"

echo ""
echo "5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (USB):"
lsusb | grep -i pantum || echo "  –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Pantum –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ USB"

echo ""
echo "======================================================"
echo "               –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–ê–õ–¨–ù–ï–ô–®–ò–• –î–ï–ô–°–¢–í–ò–ô"
echo "======================================================"
echo ""
echo "‚úÖ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û:"
echo "   ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∏ —è–¥—Ä–æ"
echo "   ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
echo "   ‚Ä¢ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω CUPS"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CUPS"
echo "   ‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–Ω—Ç–µ—Ä Pantum_P2200_series (–µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω)"
echo ""
echo "üîß –†–£–ß–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –°–ö–†–ò–ü–¢–ê:"
echo ""
echo "1. –ü–ï–ß–ê–¢–¨ –¢–ï–°–¢–û–í–û–ô –°–¢–†–ê–ù–ò–¶–´:"
echo "   echo '–¢–µ—Å—Ç –ø–µ—á–∞—Ç–∏' | lp -d Pantum_P2200_series"
echo ""
echo "2. –ü–†–û–í–ï–†–ö–ê –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–°–ê CUPS:"
echo "   –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://$(hostname -I | awk '{print $1}'):631"
echo "   –∏–ª–∏ http://localhost:631"
echo ""
echo "3. –ï–°–õ–ò –ü–ï–ß–ê–¢–¨ –ù–ï –†–ê–ë–û–¢–ê–ï–¢:"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ CUPS: sudo tail -f /var/log/cups/error_log"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ USB: –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–∞–±–µ–ª—å"
echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–Ω—Ç–µ—Ä –≤–∫–ª—é—á–µ–Ω –∏ –≤ –Ω–µ–º –µ—Å—Ç—å –±—É–º–∞–≥–∞"
echo ""
echo "4. –î–õ–Ø –ó–ê–ü–£–°–ö–ê –¢–ï–õ–ï–ì–†–ê–ú-–ë–û–¢–ê:"
echo "   ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python-–±–∏–±–ª–∏–æ—Ç–µ–∫–∏:"
echo "     pip3 install pyTelegramBotAPI pycups"
echo "   ‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: python3 /opt/telegram_print_bot/bot.py"
echo ""
echo "üìÅ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:"
echo "   ‚Ä¢ –ü–æ–ª–Ω—ã–π –ª–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: /var/log/full_fix_script.log"
echo "   ‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤: $BACKUP_DIR"
echo ""
echo "‚ö†Ô∏è  –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –ü–ï–†–ï–ó–ê–ì–†–£–ó–ò–¢–¨ –°–ò–°–¢–ï–ú–£ –î–õ–Ø –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –í–°–ï–• –ò–ó–ú–ï–ù–ï–ù–ò–ô!"
echo "   sudo reboot"
echo ""

echo "======================================================"
echo "  –°–ö–†–ò–ü–¢ –ó–ê–í–ï–†–®–ï–ù. –ü–†–û–í–ï–†–¨–¢–ï –û–¢–ß–ï–¢ –í–´–®–ï."
echo "======================================================"
